import{__assign as e,__awaiter as t,__generator as r,__read as n}from"tslib";import{done as o}from"@liff/ready";import{isLoggedIn as i}from"@liff/is-logged-in";import{convertHexToRgb as a,convertArgbToRgba as s,createLiffError as l,base64Url as c,convertArrayBuffer as f,compareVersion as u,qs as d,extractChannelIdFromLiffId as h,objectAssignKeyOnlyWithValue as p,addParamsToUrl as v,replaceUrlCredentialRemoved as w}from"@liff/util";import{getContext as m,getLoginTmp as b,getExpireTime as g,getIsSubsequentLiffApp as k,getFeatureToken as C,setIsSubsequentLiffApp as F,getMST as _,getAccessToken as y,getRawContext as B,getIDToken as I,getClientId as x,getMSTChallenge as S,getMSTVerifier as T,getMSIT as A,getConfig as E,setDecodedIDToken as L,setAppData as D,setMST as O,setFeatureToken as U,setAccessToken as P,setContext as N,setMSTChallenge as K,setMSTVerifier as W,setClientId as M,setMSIT as H,setIDToken as j,getDecodedIDToken as J,removeLoginTmp as V,setExpireTime as q,setConfig as R}from"@liff/store";import{load as z}from"@liff/extensions";import{INIT_FAILED as G,INVALID_ID_TOKEN as Q,FORBIDDEN as X,SUB_WINDOW_HEALTH_CHECK_MESSAGE as Y,INVALID_CONFIG as Z}from"@liff/consts";import{isInClient as $}from"@liff/is-in-client";import{logout as ee}from"@liff/logout";import{isSubWindow as te}from"@liff/is-sub-window";import{getMSTByMSIT as re,getAppData as ne,getMainWindowOrigin as oe,setMainWindowOrigin as ie}from"@liff/sub-window";import{fetch as ae,getEndPoint as se,verifyAccessToken as le}from"@liff/server-api";import{logger as ce}from"@liff/logger";import{getLineVersion as fe}from"@liff/get-line-version";import{addListener as ue,removeListener as de}from"@liff/native-bridge";import{isApiAvailable as he}from"@liff/is-api-available";import{getOS as pe}from"@liff/get-os";import{AsyncHook as ve}from"@liff/hooks";var we={iconColor:"#111111",statusBarColor:"BLACK",titleTextColor:"#111111",titleSubtextColor:"#B7B7B7",titleButtonColor:"#111111",titleBackgroundColor:"#FFFFFF",progressBarColor:"#06C755",progressBackgroundColor:"#FFFFFF",titleButtonAreaBackgroundColor:"#1FFFFFFF",titleButtonAreaBorderColor:"#26000000",baseBackgroundColor:"#FFFFFF",baseTextColor:"#000000",lightButtonBorderColor:"rgba(0, 0, 0, 0.15)"},me={iconColor:"#FFFFFF",statusBarColor:"WHITE",titleTextColor:"#FFFFFF",titleSubtextColor:"#949494",titleButtonColor:"#FFFFFF",titleBackgroundColor:"#111111",progressBarColor:"#06C755",progressBackgroundColor:"#111111",titleButtonAreaBackgroundColor:"#1FFFFFFF",titleButtonAreaBorderColor:"#26000000",baseBackgroundColor:"#000000",baseTextColor:"#FFFFFF",lightButtonBorderColor:"rgba(255, 255, 255, 0.5)"};function be(){var e;Ce("color-scheme",((null==(e=m())?void 0:e.menuColorSetting)||{adaptableColorSchemes:["light"]}).adaptableColorSchemes.join(" "));var t=window.matchMedia("(prefers-color-scheme: dark)");ge({matches:null==t?void 0:t.matches,media:null==t?void 0:t.media}),t.addEventListener?t.addEventListener("change",ge):t.addListener&&t.addListener(ge)}function ge(t){var r=m(),n=(null==r?void 0:r.menuColorSetting)||{adaptableColorSchemes:["light"],lightModeColor:we,darkModeColor:me},o=n.adaptableColorSchemes,i=n.lightModeColor,a=n.darkModeColor,s=o.includes("dark");t.matches&&s?ke(e(e({},me),a)):ke(e(e({},we),i))}function ke(e){var t=e.iconColor,r=e.statusBarColor,n=e.titleTextColor,o=e.titleSubtextColor,i=e.titleButtonColor,l=e.titleBackgroundColor,c=e.progressBarColor,f=e.progressBackgroundColor,u=e.titleButtonAreaBackgroundColor,d=e.titleButtonAreaBorderColor,h=e.baseBackgroundColor,p=e.baseTextColor,v=e.lightButtonBorderColor;Ce("--liff-base-background-color",h),Ce("--liff-base-text-color",p),Ce("--liff-base-background-rgb-color",a(h)),Ce("--liff-base-text-rgb-color",a(p)),Ce("--liff-light-button-border-color",v),Ce("--liff-title-text-color",n),Ce("--liff-title-background-color",l),Ce("--liff-title-button-color",i),Ce("--liff-icon-color",t),Ce("--liff-status-bar-color",r),Ce("--liff-title-subtext-color",o),Ce("--liff-progress-bar-color",c),Ce("--liff-progress-background-color",f),Ce("--liff-title-button-area-background-color",s(u)),Ce("--liff-title-button-area-border-color",s(d))}function Ce(e,t){document.documentElement.style.setProperty(e,t)}function Fe(e){return t(this,void 0,void 0,(function(){return r(this,(function(t){switch(t.label){case 0:return[4,z()];case 1:return t.sent().install(e),[2]}}))}))}function _e(){return t(this,void 0,void 0,(function(){return r(this,(function(e){switch(e.label){case 0:return[4,ae(se("certs"))];case 1:return[2,e.sent()]}}))}))}function ye(e,n,o){return t(this,void 0,void 0,(function(){var t;return r(this,(function(r){switch(r.label){case 0:return[4,crypto.subtle.importKey("jwk",e,{name:"ECDSA",namedCurve:"P-256"},!1,["verify"])];case 1:return t=r.sent(),[4,crypto.subtle.verify({name:"ECDSA",hash:{name:"SHA-256"}},t,o,n)];case 2:return[2,r.sent()]}}))}))}function Be(e,o){return t(this,void 0,void 0,(function(){var t,i,a,s,u,d,h,p,v,w,m,b,g,k,C,F;return r(this,(function(r){switch(r.label){case 0:return t=e.split("."),i=n(t,3),a=i[0],s=i[1],u=i[2],d=JSON.parse(c.decode(a)),h=JSON.parse(c.decodeUnicode(s)),p=f(c.decode(u)),v=f(a+"."+s),[4,_e()];case 1:if(w=r.sent(),!(m=w.keys.find((function(e){return e.kid===d.kid}))))return[3,6];if(delete m.alg,"ES256"!==d.alg)throw l(Q,'Invalid "alg" value in ID_TOKEN');b=void 0,r.label=2;case 2:return r.trys.push([2,4,,5]),[4,ye(m,v,p)];case 3:return b=r.sent(),[3,5];case 4:throw g=r.sent(),l(Q,"Failed to use Crypto API to verify ID_TOKEN: "+g);case 5:if(b){if(k="https://access.line.me"!==h.iss,C=h.aud!==o,F=1e3*h.exp<Date.now(),k)throw l(Q,'Invalid "iss" value in ID_TOKEN');if(C)throw l(Q,'Invalid "aud" value in ID_TOKEN');if(F)throw l(Q,'Invalid "exp" value in ID_TOKEN');return[2,h]}throw l(Q,"Invalid signature in ID_TOKEN");case 6:throw l(Q,'Invalid "kid" value in ID_TOKEN');case 7:return[2]}}))}))}function Ie(e){var t=e.split(".");if(t[1])try{var r=t[1].replace(/-/g,"+").replace(/_/g,"/");return JSON.parse(window.atob(r))}catch(n){return null}return null}function xe(e){var t=e.pathname,r=e.query,n="liff://"+t+(r?"?"+d.stringify(r):"");location.href=n}var Se=null;function Te(){"boolean"==typeof Se&&ce.warn("liff.init is not expected to be called more than once"),Se=!!k()||!(!$()||d.parse(window.location.hash).feature_token||C())&&(F(!0),!0)}function Ae(){return Boolean(Se)}function Ee(e,n){return t(this,void 0,void 0,(function(){var t;return r(this,(function(r){switch(r.label){case 0:return(t=_())?[2,t]:e&&n?[4,re({msit:e,mstVerifier:n})]:[3,2];case 1:return[2,r.sent().mst];case 2:return[2,null]}}))}))}function Le(e){return ae(se("apps")+"/"+e+"/featureToken")}function De(e){return t(this,void 0,void 0,(function(){var t,n,o,a;return r(this,(function(r){switch(r.label){case 0:return t=d.parse(window.location.hash),n=p({access_token:y(),context_token:B(),feature_token:C(),id_token:I(),client_id:x(),mst_challenge:S(),mst_verifier:T(),msit:A()},t),Ae()?i()?[4,Le(e)]:[3,2]:[3,3];case 1:o=r.sent().featureToken,n.feature_token||(n.feature_token=o),r.label=2;case 2:(a=h(e))&&(n.client_id=a),r.label=3;case 3:return[2,n]}}))}))}function Oe(e){if(e.persisted&&he("multipleLiffTransition"))if("ios"===pe())window.location.reload();else{var t=E().liffId,r=C();if(!t)throw l(G,"Invalid LIFF ID.");if(!r)throw l(X,"Invalid featureToken for client features");xe({pathname:"app/"+t,query:{feature_token:r}})}}function Ue(e,n){return t(this,void 0,void 0,(function(){var t,o;return r(this,(function(r){switch(r.label){case 0:return[4,le(e)];case 1:return t=r.sent().client_id,o=h(n),[2,t===o]}}))}))}function Pe(e,n){return t(this,void 0,void 0,(function(){var t,o,a,s,c,f,d,h,p,w,m,b,g;return r(this,(function(r){switch(r.label){case 0:return[4,new Promise((function(e){var t=fe();if(!t||u(t,"9.5.0")<0)e();else if(window._liff&&window._liff.features)e();else{ce.debug("cannot find window._liff.features, listen to ready event");var r=function(){ce.debug("ready event is fired"),de("ready",r),e()};ue("ready",r)}}))];case 1:return r.sent(),Te(),[4,De(n.liffId)];case 2:if(t=r.sent(),o=t.access_token,a=t.context_token,s=t.feature_token,c=t.id_token,f=t.client_id,d=t.mst_verifier,h=t.mst_challenge,p=t.msit,a){if("string"!=typeof a)throw l(G,"Cannot get context token, perhaps there is an incorrect parameter in permanent link");N(Ie(a))}return!te()&&s&&(!function(e,t){he("multipleLiffTransition")&&xe({pathname:"app/"+e,query:{feature_token:t}})}(n.liffId,s),Ae()&&U(s)),h&&K(h),d&&W(d),f&&M(f),p&&H(p),window.addEventListener("pageshow",Oe),i()?[3,7]:s&&o?[3,5]:Ae()?(w=v(location.href,{"liff.hback":"2"}),e.login({redirectUri:w}),[4,new Promise((function(){}))]):[3,4];case 3:r.sent(),r.label=4;case 4:throw e.login(),l(G,"Failed to parse feature_token or access_token");case 5:return[4,Ue(o,n.liffId)];case 6:if(!r.sent())throw e.login(),l(G,"Failed to verify access_token");U(s),P(o),r.label=7;case 7:return[4,Ee(p,d)];case 8:return(m=r.sent())?(O(m),[4,ne({mst:m})]):[3,10];case 9:(b=r.sent().data)&&D(JSON.stringify(b)),r.label=10;case 10:return c&&!I()&&j(c),c&&f&&!J()?[4,Be(c,f)]:[3,12];case 11:(g=r.sent())&&L(g),r.label=12;case 12:return[2]}}))}))}function Ne(e){return t(this,void 0,void 0,(function(){var t,n,o,i,a,s,c;return r(this,(function(r){switch(r.label){case 0:return t=se("apps"),n=t+"/"+e+"/contextToken",o=y(),i={"Content-Type":"application/json",Accept:"application/json"},o&&(i.Authorization="Bearer "+o),[4,ae(n,{headers:i})];case 1:if(a=r.sent(),!(s=a.contextToken))throw l(G,"Can not get context from server.");if(!(c=Ie(s)))throw l(G,"Invalid context token.");return[2,c]}}))}))}function Ke(){return t(this,void 0,void 0,(function(){var e,t;return r(this,(function(r){switch(r.label){case 0:if(!(e=E().liffId))throw l(G,"Invalid LIFF ID.");return[4,Ne(e)];case 1:return t=r.sent(),N(t),[2]}}))}))}function We(e){return t(this,void 0,void 0,(function(){var n,o,i,a=this;return r(this,(function(s){switch(s.label){case 0:n=function(){return t(a,void 0,void 0,(function(){var t,n,o,i,a,s;return r(this,(function(r){switch(r.label){case 0:return[4,(l=E(),c=d.parse(window.location.search),f=b(),u={grant_type:"authorization_code",client_id:c.liffClientId,appId:l.liffId,code:c.code,code_verifier:f.codeVerifier,redirect_uri:l.redirectUri||c.liffRedirectUri,id_token_key_type:"JWK"},h=d.stringify(u),ae(se("token"),{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded;charset=UTF-8"},body:h}))];case 1:return t=r.sent(),n=t.access_token,o=t.id_token,i=t.expires_in,M(e),P(n),q(new Date(Date.now()+1e3*i)),V(),o?(j(o),[4,Be(o,e)]):[3,3];case 2:(a=r.sent())&&L(a),r.label=3;case 3:return(s=d.parse(location.hash).context_token)?(N(Ie(s)),[3,6]):[3,4];case 4:return[4,Ke()];case 5:r.sent(),r.label=6;case 6:return[2]}var l,c,f,u,h}))}))},s.label=1;case 1:return s.trys.push([1,3,,4]),[4,n()];case 2:return s.sent(),[3,4];case 3:throw o=s.sent(),i=o,V(),i;case 4:return[2]}}))}))}var Me=new(function(){function e(){var e=this;this.getAndValidateContext=function(){var e=m();if(!e)throw l(G,"Could not get Context from server.");if(!e.endpointUrl)throw l(G,"Could not get endpointUrl from server.");if(!e.permanentLinkPattern)throw l(G,"Could not get permanentLinkPattern from server.");return e},this.decodeState=function(t){var r=e.getAndValidateContext();t=t.replace(/\n/g,"%0D%0A");var n=!r.endpointUrl.startsWith("/?")&&r.endpointUrl.includes("/?")||!r.endpointUrl.startsWith("/#")&&r.endpointUrl.includes("/#")||r.endpointUrl.endsWith("/")||!t.startsWith("/?")&&t.includes("/?")||!t.startsWith("/#")&&t.includes("/#")||t.endsWith("/"),o=new URL(r.endpointUrl),i=o.origin,a=o.pathname,s=o.search,l=new URL(""+i+e.attachSlashAtStart(t)),c=l.pathname,f=l.search,u=l.hash,d=""+s+(s?f.replace(/\?/g,"&"):f),h=(""+a+e.attachSlashAtStart(c)).replace("//","/");return(h=e.attachSlashAtStart(""+h)).endsWith("/")&&!n&&(h=h.substring(0,h.length-1)),(""+i+h+d+u).replace(/%0D%0A/g,"\n")}}return e.prototype.attachSlashAtStart=function(e){return(e&&e.length>0&&!e.startsWith("/")?"/":"")+e},e.prototype.invoke=function(){return t(this,void 0,void 0,(function(){var e,t,n,o,i;return r(this,(function(r){switch(r.label){case 0:if(e=d.parse(window.location.search),"string"!=typeof(t=e["liff.state"]))return[2];r.label=1;case 1:return r.trys.push([1,4,,5]),n=location.href,(o=this.decodeState(t))===n?[3,3]:(e["liff.hback"]?location.replace(v(o,{"liff.hback":e["liff.hback"]})):location.replace(o),[4,new Promise((function(){}))]);case 2:r.sent(),r.label=3;case 3:return[3,5];case 4:if((i=r.sent()).code===G)throw i;return ce.debug(i),[3,5];case 5:return[2]}}))}))},e}());function He(e,n,o){return t(this,void 0,void 0,(function(){var t;return r(this,(function(r){switch(r.label){case 0:if(!n.liffId)throw l(Z,"liffId is necessary for liff.init()");return R(n),!$()&&i()&&(g()||ee()),t=d.parse(window.location.search),!te()||$()?[3,2]:[4,new Promise((function(e){oe()?e():window.addEventListener("message",(function t(r){var n=r.data,o=r.source,i=r.origin;if(n){var a=n.type,s=n.message;a===Y&&(window.removeEventListener("message",t),s&&D(s),ie(i),o&&o.postMessage&&o.postMessage({status:Y},i),e())}}))}))];case 1:r.sent(),r.label=2;case 2:if(t.error&&t.liffOAuth2Error)throw c=t.error,f=t.error_description,u=f.replace(/\+/g," "),l(G,c+": "+u);return a=t.code,s=b(),Boolean(a&&!i()&&s&&s.codeVerifier)?[4,We(t.liffClientId)]:[3,4];case 3:r.sent(),r.label=4;case 4:return $()?[4,Pe(e,n)]:[3,6];case 5:return r.sent(),[3,8];case 6:return i()?[3,8]:[4,Ke()];case 7:r.sent(),r.label=8;case 8:return[4,Me.invoke()];case 9:return r.sent(),[4,o()];case 10:return r.sent(),w(window.location.href),[2]}var a,s,c,f,u}))}))}var je=function(){function e(){this.hooks={before:new ve,after:new ve},this.internalHooks={beforeFinished:new ve,beforeSuccess:new ve,error:new ve}}return Object.defineProperty(e.prototype,"name",{get:function(){return"init"},enumerable:!1,configurable:!0}),e.prototype.install=function(e){var t=e.liff;return this.liff=t,this.init.bind(this)},e.prototype.init=function(e,n,a){return t(this,void 0,void 0,(function(){var t;return r(this,(function(r){switch(r.label){case 0:return[4,this.hooks.before.call()];case 1:r.sent(),s=this.liff,window&&!window.liff&&(window.liff=s),r.label=2;case 2:return r.trys.push([2,8,,10]),[4,Promise.all([Fe(this.liff),He(this.liff,e,this.internalHooks.beforeFinished.call)])];case 3:return r.sent(),be(),[4,this.internalHooks.beforeSuccess.call()];case 4:return r.sent(),!e.withLoginOnExternalBrowser||i()?[3,6]:(this.liff.login(),[4,new Promise((function(){}))]);case 5:r.sent(),r.label=6;case 6:return[4,this.hooks.after.call()];case 7:return r.sent(),"function"==typeof n&&n(),o(),[3,10];case 8:return t=r.sent(),[4,this.internalHooks.error.call(t)];case 9:throw r.sent(),"function"==typeof a&&a(t),t;case 10:return[2]}var s}))}))},e}();export{je as InitModule};
