"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("tslib"),t=require("@liff/ready"),r=require("@liff/is-logged-in"),n=require("@liff/util"),o=require("@liff/store"),i=require("@liff/extensions"),a=require("@liff/consts"),s=require("@liff/is-in-client"),l=require("@liff/logout"),c=require("@liff/is-sub-window"),f=require("@liff/sub-window"),u=require("@liff/server-api"),d=require("@liff/logger"),g=require("@liff/get-line-version"),h=require("@liff/native-bridge"),_=require("@liff/is-api-available"),p=require("@liff/get-os"),v=require("@liff/hooks"),I={iconColor:"#111111",statusBarColor:"BLACK",titleTextColor:"#111111",titleSubtextColor:"#B7B7B7",titleButtonColor:"#111111",titleBackgroundColor:"#FFFFFF",progressBarColor:"#06C755",progressBackgroundColor:"#FFFFFF",titleButtonAreaBackgroundColor:"#1FFFFFFF",titleButtonAreaBorderColor:"#26000000",baseBackgroundColor:"#FFFFFF",baseTextColor:"#000000",lightButtonBorderColor:"rgba(0, 0, 0, 0.15)"},w={iconColor:"#FFFFFF",statusBarColor:"WHITE",titleTextColor:"#FFFFFF",titleSubtextColor:"#949494",titleButtonColor:"#FFFFFF",titleBackgroundColor:"#111111",progressBarColor:"#06C755",progressBackgroundColor:"#111111",titleButtonAreaBackgroundColor:"#1FFFFFFF",titleButtonAreaBorderColor:"#26000000",baseBackgroundColor:"#000000",baseTextColor:"#FFFFFF",lightButtonBorderColor:"rgba(255, 255, 255, 0.5)"};function b(){var e;F("color-scheme",((null==(e=o.getContext())?void 0:e.menuColorSetting)||{adaptableColorSchemes:["light"]}).adaptableColorSchemes.join(" "));var t=window.matchMedia("(prefers-color-scheme: dark)");C({matches:null==t?void 0:t.matches,media:null==t?void 0:t.media}),t.addEventListener?t.addEventListener("change",C):t.addListener&&t.addListener(C)}function C(t){var r=o.getContext(),n=(null==r?void 0:r.menuColorSetting)||{adaptableColorSchemes:["light"],lightModeColor:I,darkModeColor:w},i=n.adaptableColorSchemes,a=n.lightModeColor,s=n.darkModeColor,l=i.includes("dark");t.matches&&l?k(e.__assign(e.__assign({},w),s)):k(e.__assign(e.__assign({},I),a))}function k(e){var t=e.iconColor,r=e.statusBarColor,o=e.titleTextColor,i=e.titleSubtextColor,a=e.titleButtonColor,s=e.titleBackgroundColor,l=e.progressBarColor,c=e.progressBackgroundColor,f=e.titleButtonAreaBackgroundColor,u=e.titleButtonAreaBorderColor,d=e.baseBackgroundColor,g=e.baseTextColor,h=e.lightButtonBorderColor;F("--liff-base-background-color",d),F("--liff-base-text-color",g),F("--liff-base-background-rgb-color",n.convertHexToRgb(d)),F("--liff-base-text-rgb-color",n.convertHexToRgb(g)),F("--liff-light-button-border-color",h),F("--liff-title-text-color",o),F("--liff-title-background-color",s),F("--liff-title-button-color",a),F("--liff-icon-color",t),F("--liff-status-bar-color",r),F("--liff-title-subtext-color",i),F("--liff-progress-bar-color",l),F("--liff-progress-background-color",c),F("--liff-title-button-area-background-color",n.convertArgbToRgba(f)),F("--liff-title-button-area-border-color",n.convertArgbToRgba(u))}function F(e,t){document.documentElement.style.setProperty(e,t)}function T(t){return e.__awaiter(this,void 0,void 0,(function(){return e.__generator(this,(function(e){switch(e.label){case 0:return[4,i.load()];case 1:return e.sent().install(t),[2]}}))}))}function m(){return e.__awaiter(this,void 0,void 0,(function(){return e.__generator(this,(function(e){switch(e.label){case 0:return[4,u.fetch(u.getEndPoint("certs"))];case 1:return[2,e.sent()]}}))}))}function L(t,r,n){return e.__awaiter(this,void 0,void 0,(function(){var o;return e.__generator(this,(function(e){switch(e.label){case 0:return[4,crypto.subtle.importKey("jwk",t,{name:"ECDSA",namedCurve:"P-256"},!1,["verify"])];case 1:return o=e.sent(),[4,crypto.subtle.verify({name:"ECDSA",hash:{name:"SHA-256"}},o,n,r)];case 2:return[2,e.sent()]}}))}))}function E(t,r){return e.__awaiter(this,void 0,void 0,(function(){var o,i,s,l,c,f,u,d,g,h,_,p,v,I,w,b;return e.__generator(this,(function(C){switch(C.label){case 0:return o=t.split("."),i=e.__read(o,3),s=i[0],l=i[1],c=i[2],f=JSON.parse(n.base64Url.decode(s)),u=JSON.parse(n.base64Url.decodeUnicode(l)),d=n.convertArrayBuffer(n.base64Url.decode(c)),g=n.convertArrayBuffer(s+"."+l),[4,m()];case 1:if(h=C.sent(),!(_=h.keys.find((function(e){return e.kid===f.kid}))))return[3,6];if(delete _.alg,"ES256"!==f.alg)throw n.createLiffError(a.INVALID_ID_TOKEN,'Invalid "alg" value in ID_TOKEN');p=void 0,C.label=2;case 2:return C.trys.push([2,4,,5]),[4,L(_,g,d)];case 3:return p=C.sent(),[3,5];case 4:throw v=C.sent(),n.createLiffError(a.INVALID_ID_TOKEN,"Failed to use Crypto API to verify ID_TOKEN: "+v);case 5:if(p){if(I="https://access.line.me"!==u.iss,w=u.aud!==r,b=1e3*u.exp<Date.now(),I)throw n.createLiffError(a.INVALID_ID_TOKEN,'Invalid "iss" value in ID_TOKEN');if(w)throw n.createLiffError(a.INVALID_ID_TOKEN,'Invalid "aud" value in ID_TOKEN');if(b)throw n.createLiffError(a.INVALID_ID_TOKEN,'Invalid "exp" value in ID_TOKEN');return[2,u]}throw n.createLiffError(a.INVALID_ID_TOKEN,"Invalid signature in ID_TOKEN");case 6:throw n.createLiffError(a.INVALID_ID_TOKEN,'Invalid "kid" value in ID_TOKEN');case 7:return[2]}}))}))}function A(e){var t=e.split(".");if(t[1])try{var r=t[1].replace(/-/g,"+").replace(/_/g,"/");return JSON.parse(window.atob(r))}catch(n){return null}return null}function D(e){var t=e.pathname,r=e.query,o="liff://"+t+(r?"?"+n.qs.stringify(r):"");location.href=o}var y=null;function S(){"boolean"==typeof y&&d.logger.warn("liff.init is not expected to be called more than once"),y=!!o.getIsSubsequentLiffApp()||!(!s.isInClient()||n.qs.parse(window.location.hash).feature_token||o.getFeatureToken())&&(o.setIsSubsequentLiffApp(!0),!0)}function B(){return Boolean(y)}function x(t,r){return e.__awaiter(this,void 0,void 0,(function(){var n;return e.__generator(this,(function(e){switch(e.label){case 0:return(n=o.getMST())?[2,n]:t&&r?[4,f.getMSTByMSIT({msit:t,mstVerifier:r})]:[3,2];case 1:return[2,e.sent().mst];case 2:return[2,null]}}))}))}function N(e){return u.fetch(u.getEndPoint("apps")+"/"+e+"/featureToken")}function q(t){return e.__awaiter(this,void 0,void 0,(function(){var i,a,s,l;return e.__generator(this,(function(e){switch(e.label){case 0:return i=n.qs.parse(window.location.hash),a=n.objectAssignKeyOnlyWithValue({access_token:o.getAccessToken(),context_token:o.getRawContext(),feature_token:o.getFeatureToken(),id_token:o.getIDToken(),client_id:o.getClientId(),mst_challenge:o.getMSTChallenge(),mst_verifier:o.getMSTVerifier(),msit:o.getMSIT()},i),B()?r.isLoggedIn()?[4,N(t)]:[3,2]:[3,3];case 1:s=e.sent().featureToken,a.feature_token||(a.feature_token=s),e.label=2;case 2:(l=n.extractChannelIdFromLiffId(t))&&(a.client_id=l),e.label=3;case 3:return[2,a]}}))}))}function O(e){if(e.persisted&&_.isApiAvailable("multipleLiffTransition"))if("ios"===p.getOS())window.location.reload();else{var t=o.getConfig().liffId,r=o.getFeatureToken();if(!t)throw n.createLiffError(a.INIT_FAILED,"Invalid LIFF ID.");if(!r)throw n.createLiffError(a.FORBIDDEN,"Invalid featureToken for client features");D({pathname:"app/"+t,query:{feature_token:r}})}}function M(t,r){return e.__awaiter(this,void 0,void 0,(function(){var o,i;return e.__generator(this,(function(e){switch(e.label){case 0:return[4,u.verifyAccessToken(t)];case 1:return o=e.sent().client_id,i=n.extractChannelIdFromLiffId(r),[2,o===i]}}))}))}function U(t,i){return e.__awaiter(this,void 0,void 0,(function(){var s,l,u,p,v,I,w,b,C,k,F,T,m;return e.__generator(this,(function(e){switch(e.label){case 0:return[4,new Promise((function(e){var t=g.getLineVersion();if(!t||n.compareVersion(t,"9.5.0")<0)e();else if(window._liff&&window._liff.features)e();else{d.logger.debug("cannot find window._liff.features, listen to ready event");var r=function(){d.logger.debug("ready event is fired"),h.removeListener("ready",r),e()};h.addListener("ready",r)}}))];case 1:return e.sent(),S(),[4,q(i.liffId)];case 2:if(s=e.sent(),l=s.access_token,u=s.context_token,p=s.feature_token,v=s.id_token,I=s.client_id,w=s.mst_verifier,b=s.mst_challenge,C=s.msit,u){if("string"!=typeof u)throw n.createLiffError(a.INIT_FAILED,"Cannot get context token, perhaps there is an incorrect parameter in permanent link");o.setContext(A(u))}return!c.isSubWindow()&&p&&(!function(e,t){_.isApiAvailable("multipleLiffTransition")&&D({pathname:"app/"+e,query:{feature_token:t}})}(i.liffId,p),B()&&o.setFeatureToken(p)),b&&o.setMSTChallenge(b),w&&o.setMSTVerifier(w),I&&o.setClientId(I),C&&o.setMSIT(C),window.addEventListener("pageshow",O),r.isLoggedIn()?[3,7]:p&&l?[3,5]:B()?(k=n.addParamsToUrl(location.href,{"liff.hback":"2"}),t.login({redirectUri:k}),[4,new Promise((function(){}))]):[3,4];case 3:e.sent(),e.label=4;case 4:throw t.login(),n.createLiffError(a.INIT_FAILED,"Failed to parse feature_token or access_token");case 5:return[4,M(l,i.liffId)];case 6:if(!e.sent())throw t.login(),n.createLiffError(a.INIT_FAILED,"Failed to verify access_token");o.setFeatureToken(p),o.setAccessToken(l),e.label=7;case 7:return[4,x(C,w)];case 8:return(F=e.sent())?(o.setMST(F),[4,f.getAppData({mst:F})]):[3,10];case 9:(T=e.sent().data)&&o.setAppData(JSON.stringify(T)),e.label=10;case 10:return v&&!o.getIDToken()&&o.setIDToken(v),v&&I&&!o.getDecodedIDToken()?[4,E(v,I)]:[3,12];case 11:(m=e.sent())&&o.setDecodedIDToken(m),e.label=12;case 12:return[2]}}))}))}function K(t){return e.__awaiter(this,void 0,void 0,(function(){var r,i,s,l,c,f,d;return e.__generator(this,(function(e){switch(e.label){case 0:return r=u.getEndPoint("apps"),i=r+"/"+t+"/contextToken",s=o.getAccessToken(),l={"Content-Type":"application/json",Accept:"application/json"},s&&(l.Authorization="Bearer "+s),[4,u.fetch(i,{headers:l})];case 1:if(c=e.sent(),!(f=c.contextToken))throw n.createLiffError(a.INIT_FAILED,"Can not get context from server.");if(!(d=A(f)))throw n.createLiffError(a.INIT_FAILED,"Invalid context token.");return[2,d]}}))}))}function P(){return e.__awaiter(this,void 0,void 0,(function(){var t,r;return e.__generator(this,(function(e){switch(e.label){case 0:if(!(t=o.getConfig().liffId))throw n.createLiffError(a.INIT_FAILED,"Invalid LIFF ID.");return[4,K(t)];case 1:return r=e.sent(),o.setContext(r),[2]}}))}))}function H(t){return e.__awaiter(this,void 0,void 0,(function(){var r,i,a,s=this;return e.__generator(this,(function(l){switch(l.label){case 0:r=function(){return e.__awaiter(s,void 0,void 0,(function(){var r,i,a,s,l,c;return e.__generator(this,(function(e){switch(e.label){case 0:return[4,(f=o.getConfig(),d=n.qs.parse(window.location.search),g=o.getLoginTmp(),h={grant_type:"authorization_code",client_id:d.liffClientId,appId:f.liffId,code:d.code,code_verifier:g.codeVerifier,redirect_uri:f.redirectUri||d.liffRedirectUri,id_token_key_type:"JWK"},_=n.qs.stringify(h),u.fetch(u.getEndPoint("token"),{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded;charset=UTF-8"},body:_}))];case 1:return r=e.sent(),i=r.access_token,a=r.id_token,s=r.expires_in,o.setClientId(t),o.setAccessToken(i),o.setExpireTime(new Date(Date.now()+1e3*s)),o.removeLoginTmp(),a?(o.setIDToken(a),[4,E(a,t)]):[3,3];case 2:(l=e.sent())&&o.setDecodedIDToken(l),e.label=3;case 3:return(c=n.qs.parse(location.hash).context_token)?(o.setContext(A(c)),[3,6]):[3,4];case 4:return[4,P()];case 5:e.sent(),e.label=6;case 6:return[2]}var f,d,g,h,_}))}))},l.label=1;case 1:return l.trys.push([1,3,,4]),[4,r()];case 2:return l.sent(),[3,4];case 3:throw i=l.sent(),a=i,o.removeLoginTmp(),a;case 4:return[2]}}))}))}var W=new(function(){function t(){var e=this;this.getAndValidateContext=function(){var e=o.getContext();if(!e)throw n.createLiffError(a.INIT_FAILED,"Could not get Context from server.");if(!e.endpointUrl)throw n.createLiffError(a.INIT_FAILED,"Could not get endpointUrl from server.");if(!e.permanentLinkPattern)throw n.createLiffError(a.INIT_FAILED,"Could not get permanentLinkPattern from server.");return e},this.decodeState=function(t){var r=e.getAndValidateContext();t=t.replace(/\n/g,"%0D%0A");var n=!r.endpointUrl.startsWith("/?")&&r.endpointUrl.includes("/?")||!r.endpointUrl.startsWith("/#")&&r.endpointUrl.includes("/#")||r.endpointUrl.endsWith("/")||!t.startsWith("/?")&&t.includes("/?")||!t.startsWith("/#")&&t.includes("/#")||t.endsWith("/"),o=new URL(r.endpointUrl),i=o.origin,a=o.pathname,s=o.search,l=new URL(""+i+e.attachSlashAtStart(t)),c=l.pathname,f=l.search,u=l.hash,d=""+s+(s?f.replace(/\?/g,"&"):f),g=(""+a+e.attachSlashAtStart(c)).replace("//","/");return(g=e.attachSlashAtStart(""+g)).endsWith("/")&&!n&&(g=g.substring(0,g.length-1)),(""+i+g+d+u).replace(/%0D%0A/g,"\n")}}return t.prototype.attachSlashAtStart=function(e){return(e&&e.length>0&&!e.startsWith("/")?"/":"")+e},t.prototype.invoke=function(){return e.__awaiter(this,void 0,void 0,(function(){var t,r,o,i,s;return e.__generator(this,(function(e){switch(e.label){case 0:if(t=n.qs.parse(window.location.search),"string"!=typeof(r=t["liff.state"]))return[2];e.label=1;case 1:return e.trys.push([1,4,,5]),o=location.href,(i=this.decodeState(r))===o?[3,3]:(t["liff.hback"]?location.replace(n.addParamsToUrl(i,{"liff.hback":t["liff.hback"]})):location.replace(i),[4,new Promise((function(){}))]);case 2:e.sent(),e.label=3;case 3:return[3,5];case 4:if((s=e.sent()).code===a.INIT_FAILED)throw s;return d.logger.debug(s),[3,5];case 5:return[2]}}))}))},t}());function V(t,i,u){return e.__awaiter(this,void 0,void 0,(function(){var d;return e.__generator(this,(function(e){switch(e.label){case 0:if(!i.liffId)throw n.createLiffError(a.INVALID_CONFIG,"liffId is necessary for liff.init()");return o.setConfig(i),!s.isInClient()&&r.isLoggedIn()&&(o.getExpireTime()||l.logout()),d=n.qs.parse(window.location.search),!c.isSubWindow()||s.isInClient()?[3,2]:[4,new Promise((function(e){f.getMainWindowOrigin()?e():window.addEventListener("message",(function t(r){var n=r.data,i=r.source,s=r.origin;if(n){var l=n.type,c=n.message;l===a.SUB_WINDOW_HEALTH_CHECK_MESSAGE&&(window.removeEventListener("message",t),c&&o.setAppData(c),f.setMainWindowOrigin(s),i&&i.postMessage&&i.postMessage({status:a.SUB_WINDOW_HEALTH_CHECK_MESSAGE},s),e())}}))}))];case 1:e.sent(),e.label=2;case 2:if(d.error&&d.liffOAuth2Error)throw _=d.error,p=d.error_description,v=_+": "+p.replace(/\+/g," "),n.createLiffError(a.INIT_FAILED,v);return g=d.code,h=o.getLoginTmp(),Boolean(g&&!r.isLoggedIn()&&h&&h.codeVerifier)?[4,H(d.liffClientId)]:[3,4];case 3:e.sent(),e.label=4;case 4:return s.isInClient()?[4,U(t,i)]:[3,6];case 5:return e.sent(),[3,8];case 6:return r.isLoggedIn()?[3,8]:[4,P()];case 7:e.sent(),e.label=8;case 8:return[4,W.invoke()];case 9:return e.sent(),[4,u()];case 10:return e.sent(),n.replaceUrlCredentialRemoved(window.location.href),[2]}var g,h,_,p,v}))}))}var R=function(){function n(){this.hooks={before:new v.AsyncHook,after:new v.AsyncHook},this.internalHooks={beforeFinished:new v.AsyncHook,beforeSuccess:new v.AsyncHook,error:new v.AsyncHook}}return Object.defineProperty(n.prototype,"name",{get:function(){return"init"},enumerable:!1,configurable:!0}),n.prototype.install=function(e){var t=e.liff;return this.liff=t,this.init.bind(this)},n.prototype.init=function(n,o,i){return e.__awaiter(this,void 0,void 0,(function(){var a;return e.__generator(this,(function(e){switch(e.label){case 0:return[4,this.hooks.before.call()];case 1:e.sent(),s=this.liff,window&&!window.liff&&(window.liff=s),e.label=2;case 2:return e.trys.push([2,8,,10]),[4,Promise.all([T(this.liff),V(this.liff,n,this.internalHooks.beforeFinished.call)])];case 3:return e.sent(),b(),[4,this.internalHooks.beforeSuccess.call()];case 4:return e.sent(),!n.withLoginOnExternalBrowser||r.isLoggedIn()?[3,6]:(this.liff.login(),[4,new Promise((function(){}))]);case 5:e.sent(),e.label=6;case 6:return[4,this.hooks.after.call()];case 7:return e.sent(),"function"==typeof o&&o(),t.done(),[3,10];case 8:return a=e.sent(),[4,this.internalHooks.error.call(a)];case 9:throw e.sent(),"function"==typeof i&&i(a),a;case 10:return[2]}var s}))}))},n}();exports.InitModule=R;
